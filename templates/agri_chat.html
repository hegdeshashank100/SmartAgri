<!-- templates/agri_chat.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAgri Chatbot</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='agri_chat.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="neumorphic-header">
        <a href="{{ url_for('index') }}" class="back-btn neumorphic neumorphic-button">‚Üê Back</a>
        <h1>SmartAgri üåæ</h1>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="message bot-message">
                <span class="icon bot-icon">ü§ñ</i></span>
                <p>üëã Hello! I'm your SmartAgri Assistant. How can I assist you today?</p>
            </div>
        </div>

        <!-- Chat Input Form -->
        <form id="chatForm" class="chat-input-form">
            <div class="row g-2 align-items-center">
                <!-- Language Selection -->
                <div class="col-12 col-md-3 mx-auto">
                    <p>Language</p>
                    <select id="language" name="language" class="form-select neumorphic">
                        {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code == 'none' %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Input Box -->
                <div class="col-12 col-md-6">
                    <input type="text" id="query" name="query" class="form-control neumorphic" placeholder="Type your question..." required>
                </div>

                <!-- Send Button -->
                <div class="col-12 col-md-3 mx-auto">
                    <button type="submit" class="send-btn neumorphic neumorphic-button w-100">Send</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer class="neumorphic-footer">
        <p>¬© 2025 SmartAgri - Helping Farmers with AI</p>
    </footer>

    <!-- Butterfly Loader -->
    <div class="loader" id="loader" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const chatForm = document.getElementById('chatForm');
        const chatWindow = document.getElementById('chatWindow');
        const queryInput = document.getElementById('query');
        const languageSelect = document.getElementById('language');
        const loader = document.getElementById('loader');

        // Function to add typing indicator
        function showTypingIndicator() {
            const typing = document.createElement('div');
            typing.classList.add('message', 'bot-message', 'typing');
            typing.innerHTML = `<span class="icon bot-icon">ü§ñ</span><p><span class="typing-dots">...</span></p>`;
            chatWindow.appendChild(typing);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return typing;
        }

        // Function to remove typing indicator
        function removeTypingIndicator(typingElement) {
            if (typingElement) typingElement.remove();
        }

        // Function to add a message
        function addMessage(content, isBot = true) {
            const message = document.createElement('div');
            message.classList.add('message', isBot ? 'bot-message' : 'user-message');
            message.innerHTML = `<span class="icon ${isBot ? 'bot-icon' : 'user-icon'}">${isBot ? 'ü§ñ' : 'üë®'}</span><p>${content}</p>`;
            chatWindow.appendChild(message);
            message.classList.add('message-appear');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Ensure welcome message is visible on load
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessage = document.querySelector('.bot-message');
            if (welcomeMessage) {
                welcomeMessage.classList.add('message-appear');
            }
        });

        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const query = queryInput.value.trim();
            const language = languageSelect.value;

            if (!query) {
                alert('Please enter a question.');
                return;
            }

            // Add user's message
            addMessage(query, false);

            // Clear input
            queryInput.value = '';

            // Show loader
            loader.style.display = 'flex';

            // Send request to chatbot API
            try {
                const response = await fetch('/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, language }),
                });

                const data = await response.json();

                // Hide loader
                loader.style.display = 'none';

                if (data.error) {
                    addMessage(data.error);
                } else {
                    // Add bot response
                    addMessage(data.response || "I‚Äôm sorry, I couldn‚Äôt process that. Please try again!");

                    // Reset language to "Auto" if instructed
                    if (data.reset_language_to === "none") {
                        languageSelect.value = "none";
                    }
                }
            } catch (error) {
                // Hide loader
                loader.style.display = 'none';
                addMessage("Sorry, I couldn‚Äôt connect to the server. Please try again later!");
            }
        });
    </script>
</body>
</html>