<!-- templates/disease_detection.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Disease Detection - SmartAgri</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='disease_detection.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="neumorphic-header">
        <a href="{{ url_for('index') }}" class="back-btn neumorphic">â† Back</a>
        <h1>SmartAgri ğŸŒ¾</h1>
    </header>

    <!-- Main Content -->
    <div class="container">
        <h1>ğŸŒ± AI Plant Disease Detection</h1>
        <p class="text-muted">Upload an image, capture a photo, or describe the symptoms to detect plant diseases.</p>

        <div class="row g-3">
            <!-- Language Selection -->
            <div class="col-12 col-md-6 mx-auto">
                <label for="languageSelect" class="form-label">ğŸŒ Select Language:</label>
                <select id="languageSelect" class="form-select neumorphic">
                    <option value="au">Auto</option>
                    <option value="en">English</option>
                    <option value="kn">Kannada</option>
                    <option value="hi">Hindi</option>
                    <option value="sp">Spanish</option>
                    <option value="te">Telugu</option>
                </select>
            </div>

            <!-- Image Upload -->
            <div class="col-12">
                <input type="file" id="imageInput" class="form-control neumorphic">
                <button class="btn neumorphic-button w-100 mt-2" onclick="uploadImage()">ğŸ“· Upload & Analyze</button>
            </div>

            <!-- Camera Capture -->
            <div class="col-12 text-center">
                <h3>OR</h3>
                <button class="btn neumorphic-button w-100" onclick="startCamera()">ğŸ“¸ Open Camera</button>
                <video id="video" autoplay class="mt-3"></video>
                <div class="camera-controls mt-2">
                    <button id="switchCameraBtn" class="btn neumorphic-button hidden" onclick="switchCamera()">ğŸ”„ Switch Camera</button>
                    <button id="captureBtn" class="btn neumorphic-button w-100 mt-2 hidden" onclick="captureImage()">ğŸ“¸ Capture</button>
                </div>
                <canvas id="canvas"></canvas>
            </div>

            <!-- Description Input -->
            <div class="col-12">
                <h3>OR</h3>
                <label for="descriptionInput" class="form-label">âœï¸ Describe Symptoms (if no camera/image):</label>
                <textarea id="descriptionInput" class="form-control neumorphic" rows="4" placeholder="e.g., Yellowing leaves with brown spots..."></textarea>
                <button class="btn neumorphic-button w-100 mt-2" onclick="analyzeDescription()">ğŸ” Analyze Description</button>
            </div>

            <!-- Result -->
            <div id="result-container" class="col-12 hidden">
                <h3>ğŸ©º Diagnosis Result</h3>
                <div id="result" class="result-box neumorphic"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="neumorphic-footer">
        <p>Â© 2025 SmartAgri. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentStream = null;
        let facingMode = 'environment'; // Default to back camera

        function startCamera() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const switchCameraBtn = document.getElementById('switchCameraBtn');

            // Stop any existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            // Set up constraints for the camera
            const constraints = {
                video: {
                    facingMode: facingMode // 'environment' for back, 'user' for front
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.style.display = 'block';
                    captureBtn.classList.remove('hidden');
                    switchCameraBtn.classList.remove('hidden');
                })
                .catch((err) => {
                    console.error("Error accessing camera: ", err);
                    alert("Camera access denied or not available.");
                });
        }

        function switchCamera() {
            // Toggle between front and back camera
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            startCamera(); // Restart the camera with the new facing mode
        }

        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const language = document.getElementById('languageSelect').value;
            const resultContainer = document.getElementById('result-container');
            const resultBox = document.getElementById('result');

            if (language === 'au') {
                alert("Please select a language for image analysis.");
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Stop the video stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            video.style.display = 'none';
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('switchCameraBtn').classList.add('hidden');

            resultBox.innerHTML = "Analyzing captured image... Please wait.";
            resultContainer.classList.remove("hidden");

            canvas.toBlob(blob => {
                let formData = new FormData();
                formData.append("image", blob, "captured_image.jpg");
                formData.append("language", language);

                fetch("/upload", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultBox.innerHTML = `<strong>Error: ${data.error}</strong>`;
                    } else {
                        resultBox.innerHTML = `<strong>${data.disease_info}</strong>`;
                    }
                    resultContainer.classList.remove("hidden");
                })
                .catch(error => {
                    console.error("Error:", error);
                    resultBox.innerHTML = `<strong>Error: Failed to analyze image.</strong>`;
                });
            });
        }

        function uploadImage() {
            const fileInput = document.getElementById('imageInput');
            const language = document.getElementById('languageSelect').value;
            const resultContainer = document.getElementById('result-container');
            const resultBox = document.getElementById('result');

            if (language === 'au') {
                alert("Please select a language for image analysis.");
                return;
            }

            if (fileInput.files && fileInput.files[0]) {
                resultBox.innerHTML = "Analyzing image... Please wait.";
                resultContainer.classList.remove("hidden");

                let formData = new FormData();
                formData.append("image", fileInput.files[0]);
                formData.append("language", language);

                fetch("/upload", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultBox.innerHTML = `<strong>Error: ${data.error}</strong>`;
                    } else {
                        resultBox.innerHTML = `<strong>${data.disease_info}</strong>`;
                    }
                    resultContainer.classList.remove("hidden");
                })
                .catch(error => {
                    console.error("Error:", error);
                    resultBox.innerHTML = `<strong>Error: Failed to analyze image.</strong>`;
                });
            } else {
                alert("Please select an image first!");
            }
        }

        function analyzeDescription() {
            const description = document.getElementById('descriptionInput').value;
            const language = document.getElementById('languageSelect').value;
            const resultContainer = document.getElementById('result-container');
            const resultBox = document.getElementById('result');

            if (!description) {
                alert("Please enter a description of the symptoms!");
                return;
            }

            resultBox.innerHTML = "Analyzing description... Please wait.";
            resultContainer.classList.remove("hidden");

            let formData = new FormData();
            formData.append("description", description);
            formData.append("language", language);

            fetch("/upload", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultBox.innerHTML = `<strong>Error: ${data.error}</strong>`;
                } else {
                    resultBox.innerHTML = `<strong>${data.disease_info}</strong>`;
                }
                resultContainer.classList.remove("hidden");
            })
            .catch(error => {
                console.error("Error:", error);
                resultBox.innerHTML = `<strong>Error: Failed to analyze description.</strong>`;
            });
        }
    </script>
</body>
</html>