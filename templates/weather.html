<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast - SmartAgri</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='weather.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="neumorphic-header">
        <a href="{{ url_for('index') }}" class="back-btn neumorphic small-button">← Back</a>
        <h1>SmartAgri 🌾</h1>
    </header>

    <!-- Main Content -->
    <div class="container">
        <h1>☀️ 7-Day Weather Forecast</h1>
        <p class="text-muted">Get the weather forecast for the next 7 days at your location.</p>

        <button class="neumorphic neumorphic-button" onclick="getWeather()">📍 Get 7-Day Forecast</button>

        <div id="weather" class="weather-display hidden">
            <h3>Fetching weather data...</h3>
        </div>
    </div>

    <!-- Footer -->
    <footer class="neumorphic-footer">
        <p>© 2025 SmartAgri. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function getWeather() {
            const weatherDiv = document.getElementById("weather");
            weatherDiv.classList.remove("hidden");
            weatherDiv.innerHTML = "<h3>Fetching weather data...</h3>";

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    console.log(`Latitude: ${lat}, Longitude: ${lon}`);

                    fetch("/weather", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ latitude: lat, longitude: lon })
                    })
                    .then(response => {
                        console.log("Fetch Response Status:", response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Weather Data:", data);
                        if (data.error) {
                            weatherDiv.innerHTML = `<p>❌ Weather data not found! Error: ${data.error}</p>`;
                        } else {
                            let html = `<h3>🌍 ${data.location}</h3>`;
                            html += '<div class="weather-details">';
                            data.forecast.forEach(day => {
                                html += `
                                    <div class="weather-item">
                                        <h4>${day.date}</h4>
                                        <img src="${day.icon}" alt="Weather Icon">
                                        <p><span class="weather-icon">🌡</span> Temp: ${day.temperature}°C</p>
                                        <p><span class="weather-icon">💧</span> Humidity: ${day.humidity}%</p>
                                        <p><span class="weather-icon">💦</span> Rain Chance: ${day.chance_of_rain}%</p>
                                        <p><span class="weather-icon">💨</span> Wind: ${day.wind_speed} m/s</p>
                                        <p><span class="weather-icon">☁</span> ${day.description}</p>
                                    </div>
                                `;
                            });
                            html += '</div>';
                            weatherDiv.innerHTML = html;
                        }
                    })
                    .catch(error => {
                        console.error("Fetch Error:", error);
                        weatherDiv.innerHTML = "<p>❌ Error fetching weather data!</p>";
                    });
                }, function(error) {
                    console.error("Geolocation Error:", error.message);
                    weatherDiv.innerHTML = "<p>❌ Location access denied! Please allow location permissions.</p>";
                });
            } else {
                weatherDiv.innerHTML = "<p>❌ Geolocation is not supported by your browser.</p>";
            }
        }
    </script>
</body>
</html>